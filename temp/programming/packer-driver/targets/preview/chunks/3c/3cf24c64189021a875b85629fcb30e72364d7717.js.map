{"version":3,"sources":["file:///Users/michael/Desktop/gitfiles/coscos_oop_frame_wrok/assets/core/common/loader/ResManager.ts"],"names":["ResManager","assetManager","Fwk","defaultBundleName","load","args","bundleName","bundle","ensureBundle","Promise","resolve","reject","paths","type","onProgress","err","assets","log","error","JSON","stringify","message","onComplete","preload","loadDir","dir","preloadDir","loadBundle","name","options","bundlePromise","getBundle","bundles","get","release","path","Array","isArray","forEach","p","asset","decRef","releaseDir","infos","getDirWithPath","info"],"mappings":"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","sourcesContent":["\n\n\nimport { __private, Asset, assetManager, AssetManager, resources } from \"cc\";\nimport { utils } from \"../utils/utils\";\nimport { Fwk } from \"../../Fwks\";\n\nexport type AssetType<T = Asset> = __private.__types_globals__Constructor<T>;\n\n// 补充类型声明\nexport type Paths = string | string[];\nexport type ProgressCallback = (finished: number, total: number, item: any) => void;\nexport type CompleteCallback = (err: Error | null, asset: any) => void;\n\n/** 加载普通资源的参数 */\nexport interface IResArgs<T extends Asset> {\n    /** 资源包名 */\n    bundle?: string;\n    /** 资源路径 */\n    paths: Paths;\n    /** 资源类型 */\n    type: AssetType<T>;\n    /** 资源加载进度 */\n    onProgress?: ProgressCallback;\n    /** 资源加载完成 */\n    onComplete?: CompleteCallback;\n}\n\n/** 加载目录资源的参数 */\nexport interface IResDirArgs<T extends Asset> {\n    /** 资源包名 */\n    bundle?: string;\n    /** 资源文件夹路径 */\n    dir: string;\n    /** 资源类型 */\n    type: AssetType<T>;\n    /** 资源加载进度 */\n    onProgress?: ProgressCallback;\n    /** 资源加载完成 */\n    onComplete?: CompleteCallback;\n}\n\n/**\n * 资源管理器\n */\nexport class ResManager {\n\n\n    /** 全局默认加载的资源包名 */\n    defaultBundleName: string = \"resources\";\n\n    /**\n     * 加载资源\n     * @param args IResArgs 参数\n     */\n    async load<T extends Asset>(args: IResArgs<T>): Promise<T | T[]> {\n        const bundleName: string = args.bundle || this.defaultBundleName;\n        const bundle: AssetManager.Bundle = await this.ensureBundle(bundleName);\n\n        return new Promise<T | T[]>((resolve, reject) => {\n            bundle.load(\n                args.paths as any,\n                args.type,\n                args.onProgress,\n                (err: Error | null, assets: any) => {\n                    if (err) {\n                        reject(err);\n                        Fwk.log.error(`ResManager: 资源加载失败 - Bundle: ${bundleName}, Paths: ${JSON.stringify(args.paths)}, Error: ${err.message}`);\n                    } else {\n                        resolve(assets);\n                        args.onComplete?.(null, assets);\n                    }\n                }\n            );\n        });\n    }\n\n    /**\n     * 预加载资源\n     * @param args IResArgs 参数\n     */\n    async preload<T extends Asset>(args: IResArgs<T>): Promise<void> {\n        const bundleName: string = args.bundle || this.defaultBundleName;\n        const bundle: AssetManager.Bundle = await this.ensureBundle(bundleName);\n\n        return new Promise<void>((resolve, reject) => {\n            bundle.preload(\n                args.paths as any,\n                args.type,\n                args.onProgress,\n                (err: Error | null) => {\n                    if (err) {\n                        reject(err);\n                        Fwk.log.error(`ResManager: 资源预加载失败 - Bundle: ${bundleName}, Paths: ${JSON.stringify(args.paths)}, Error: ${err.message}`);\n                    } else {\n                        resolve();\n                        args.onComplete?.(null, null);\n                    }\n                }\n            );\n        });\n    }\n\n    /**\n     * 加载目录资源\n     * @param args IResDirArgs 参数\n     */\n    async loadDir<T extends Asset>(args: IResDirArgs<T>): Promise<T[]> {\n        const bundleName: string = args.bundle || this.defaultBundleName;\n        const bundle: AssetManager.Bundle = await this.ensureBundle(bundleName);\n\n        return new Promise<T[]>((resolve, reject) => {\n            bundle.loadDir(\n                args.dir,\n                args.type,\n                args.onProgress,\n                (err: Error | null, assets: T[]) => {\n                    if (err) {\n                        reject(err);\n                        Fwk.log.error(`ResManager: 目录资源加载失败 - Bundle: ${bundleName}, Dir: ${args.dir}, Error: ${err.message}`);\n                    } else {\n                        resolve(assets);\n                        args.onComplete?.(null, assets);\n                    }\n                }\n            );\n        });\n    }\n\n    /**\n     * 预加载目录资源\n     * @param args IResDirArgs 参数\n     */\n    async preloadDir<T extends Asset>(args: IResDirArgs<T>): Promise<void> {\n        const bundleName: string = args.bundle || this.defaultBundleName;\n        const bundle: AssetManager.Bundle = await this.ensureBundle(bundleName);\n\n        return new Promise<void>((resolve, reject) => {\n            bundle.preloadDir(\n                args.dir,\n                args.type,\n                args.onProgress,\n                (err: Error | null) => {\n                    if (err) {\n                        reject(err);\n                        Fwk.log.error(`ResManager: 目录资源预加载失败 - Bundle: ${bundleName}, Dir: ${args.dir}, Error: ${err.message}`);\n                    } else {\n                        resolve();\n                        args.onComplete?.(null, null);\n                    }\n                }\n            );\n        });\n    }\n\n    /**\n     * 加载资源包\n     * @param name 资源包名\n     * @param options 资源参数,例:{ version: \"74fbe\" }\n     */\n    async loadBundle(name: string, options: Record<string, any> = {}): Promise<AssetManager.Bundle> {\n        const bundlePromise: Promise<AssetManager.Bundle> = new Promise<AssetManager.Bundle>((resolve, reject) => {\n            assetManager.loadBundle(name, options, (err: Error | null, bundle: AssetManager.Bundle) => {\n                if (err) {\n                    reject(err);\n                    Fwk.log.error(`ResManager: 资源包加载失败 - Name: ${name}, Error: ${err.message}`);\n                } else {\n                    resolve(bundle);\n                }\n            });\n        });\n\n        return bundlePromise;\n    }\n\n    /**\n     * 获取资源包\n     * @param name 资源包名\n     */\n    getBundle(name: string): AssetManager.Bundle | undefined {\n        return assetManager.bundles.get(name);\n    }\n\n    /**\n     * 确保资源包已加载\n     */\n    private async ensureBundle(name: string): Promise<AssetManager.Bundle> {\n        let bundle = assetManager.bundles.get(name);\n        if (!bundle) {\n            bundle = await this.loadBundle(name);\n        }\n        return bundle;\n    }\n\n\n    /**\n     * 释放资源\n     * @param args 释放选项\n     */\n    release<T extends Asset>(args: IResArgs<T>) {\n        const bundleName = args.bundle || this.defaultBundleName;\n        const bundle = assetManager.getBundle(bundleName);\n        const path = args.paths;\n\n        if (bundle) {\n            if (Array.isArray(path)) {\n                path.forEach(p => {\n                    const asset = bundle.get(p);\n                    if (asset) asset.decRef();\n                });\n            } else {\n                const asset = bundle.get(path);\n                if (asset) asset.decRef();\n            }\n        }\n    }\n\n    /**\n     * 释放目录资源\n     * @param args 释放选项\n     */\n    releaseDir<T extends Asset>(args: IResDirArgs<T>) {\n        const bundleName = args.bundle || this.defaultBundleName;\n        const bundle = assetManager.getBundle(bundleName);\n\n        if (bundle) {\n            const infos = bundle.getDirWithPath(args.dir);\n            infos.forEach(info => {\n                const asset = bundle.get(info.path, args.type);\n                if (asset) asset.decRef();\n            });\n        }\n    }\n\n\n}"]}