{"version":3,"sources":["file:///Users/michael/Desktop/gitfiles/coscos_oop_frame_wrok/assets/core/common/loader/ResManager.ts"],"names":["ResManager","assetManager","Fwk","defaultBundleName","load","options","bundleName","bundle","ensureBundle","path","type","assetPromise","Promise","resolve","reject","err","asset","log","error","message","loadBundle","name","bundlePromise","getBundle","bundles","get","release","decRef"],"mappings":";;;kGAuBaA,U;;;;;;;;;;;;;;;AArBcC,MAAAA,Y,OAAAA,Y;;AAElBC,MAAAA,G,iBAAAA,G;;;;;;;;;AAIT;AACA;AACA;;AAUA;AACA;AACA;4BACaF,U,GAAN,MAAMA,UAAN,CAAiB;AAAA;AAGpB;AAHoB,eAIpBG,iBAJoB,GAIQ,WAJR;AAAA;;AAMpB;AACJ;AACA;AACA;AACc,cAAJC,IAAI,CAAkBC,OAAlB,EAA+E;AACrF,gBAAMC,UAAkB,GAAGD,OAAO,CAACC,UAAR,IAAsB,KAAKH,iBAAtD;AACA,gBAAMI,MAA2B,GAAG,MAAM,KAAKC,YAAL,CAAkBF,UAAlB,CAA1C;AACA,gBAAMG,IAAY,GAAGJ,OAAO,CAACI,IAA7B;AACA,gBAAMC,IAAkB,GAAGL,OAAO,CAACK,IAAnC;AAEA,gBAAMC,YAAwB,GAAG,IAAIC,OAAJ,CAAe,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACjEP,YAAAA,MAAM,CAACH,IAAP,CAAYK,IAAZ,EAAkBC,IAAlB,EAAwB,CAACK,GAAD,EAAoBC,KAApB,KAAiC;AACrD,kBAAID,GAAJ,EAAS;AACLD,gBAAAA,MAAM,CAACC,GAAD,CAAN;AACA;AAAA;AAAA,gCAAIE,GAAJ,CAAQC,KAAR,CAAe,gCAA+BZ,UAAW,WAAUG,IAAK,YAAWM,GAAG,CAACI,OAAQ,EAA/F;AACH,eAHD,MAGO;AACHN,gBAAAA,OAAO,CAACG,KAAD,CAAP;AACH;AACJ,aAPD;AAQH,WATgC,CAAjC;AAWA,iBAAOL,YAAP;AACH;AAED;AACJ;AACA;AACA;AACA;;;AACoB,cAAVS,UAAU,CAACC,IAAD,EAAehB,OAA4B,GAAG,EAA9C,EAAgF;AAC5F,gBAAMiB,aAA2C,GAAG,IAAIV,OAAJ,CAAiC,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtGb,YAAAA,YAAY,CAACmB,UAAb,CAAwBC,IAAxB,EAA8BhB,OAA9B,EAAuC,CAACU,GAAD,EAAoBR,MAApB,KAAoD;AACvF,kBAAIQ,GAAJ,EAAS;AACLD,gBAAAA,MAAM,CAACC,GAAD,CAAN;AACA;AAAA;AAAA,gCAAIE,GAAJ,CAAQC,KAAR,CAAe,+BAA8BG,IAAK,YAAWN,GAAG,CAACI,OAAQ,EAAzE;AACH,eAHD,MAGO;AACHN,gBAAAA,OAAO,CAACN,MAAD,CAAP;AACH;AACJ,aAPD;AAQH,WATmD,CAApD;AAWA,iBAAOe,aAAP;AACH;AAED;AACJ;AACA;AACA;;;AACIC,QAAAA,SAAS,CAACF,IAAD,EAAgD;AACrD,iBAAOpB,YAAY,CAACuB,OAAb,CAAqBC,GAArB,CAAyBJ,IAAzB,CAAP;AACH;AAED;AACJ;AACA;;;AAC8B,cAAZb,YAAY,CAACa,IAAD,EAA6C;AACnE,cAAId,MAAM,GAAGN,YAAY,CAACuB,OAAb,CAAqBC,GAArB,CAAyBJ,IAAzB,CAAb;;AACA,cAAI,CAACd,MAAL,EAAa;AACTA,YAAAA,MAAM,GAAG,MAAM,KAAKa,UAAL,CAAgBC,IAAhB,CAAf;AACH;;AACD,iBAAOd,MAAP;AACH;AAGD;AACJ;AACA;AACA;;;AACImB,QAAAA,OAAO,CAACrB,OAAD,EAAsB;AACzB,gBAAMC,UAAU,GAAGD,OAAO,CAACC,UAAR,IAAsB,KAAKH,iBAA9C;AACA,gBAAMI,MAAM,GAAGN,YAAY,CAACsB,SAAb,CAAuBjB,UAAvB,CAAf;;AAEA,cAAIC,MAAJ,EAAY;AACR,kBAAMS,KAAK,GAAGT,MAAM,CAACkB,GAAP,CAAWpB,OAAO,CAACI,IAAnB,CAAd;;AACA,gBAAIO,KAAJ,EAAW;AACPA,cAAAA,KAAK,CAACW,MAAN;AACH;AACJ;AACJ;;AApFmB,O","sourcesContent":["\n\nimport { __private, Asset, assetManager, AssetManager, resources } from \"cc\";\nimport { utils } from \"../utils/utils\";\nimport { Fwk } from \"../../Fwks\";\n\nexport type AssetType<T = Asset> = __private.__types_globals__Constructor<T>;\n\n/**\n * 资源操作选项\n */\nexport interface ResOptions<T extends Asset = Asset> {\n    /** 资源路径 */\n    path: string;\n    /** 资源类型（加载时必传，释放时可选） */\n    type?: AssetType<T>;\n    /** 资源包名（可选，默认使用 defaultBundleName） */\n    bundleName?: string;\n}\n\n/**\n * 资源管理器\n */\nexport class ResManager {\n\n\n    /** 全局默认加载的资源包名 */\n    defaultBundleName: string = \"resources\";\n\n    /**\n     * 加载资源\n     * @param options 加载选项\n     */\n    async load<T extends Asset>(options: ResOptions<T> & { type: AssetType<T> }): Promise<T> {\n        const bundleName: string = options.bundleName || this.defaultBundleName;\n        const bundle: AssetManager.Bundle = await this.ensureBundle(bundleName);\n        const path: string = options.path;\n        const type: AssetType<T> = options.type;\n        \n        const assetPromise: Promise<T> = new Promise<T>((resolve, reject) => {\n            bundle.load(path, type, (err: Error | null, asset: T) => {\n                if (err) {\n                    reject(err);\n                    Fwk.log.error(`ResManager: 资源加载失败 - Bundle: ${bundleName}, Path: ${path}, Error: ${err.message}`);\n                } else {\n                    resolve(asset);\n                }\n            });\n        });\n\n        return assetPromise;\n    }\n\n    /**\n     * 加载资源包\n     * @param name 资源包名\n     * @param options 资源参数,例:{ version: \"74fbe\" }\n     */\n    async loadBundle(name: string, options: Record<string, any> = {}): Promise<AssetManager.Bundle> {\n        const bundlePromise: Promise<AssetManager.Bundle> = new Promise<AssetManager.Bundle>((resolve, reject) => {\n            assetManager.loadBundle(name, options, (err: Error | null, bundle: AssetManager.Bundle) => {\n                if (err) {\n                    reject(err);\n                    Fwk.log.error(`ResManager: 资源包加载失败 - Name: ${name}, Error: ${err.message}`);\n                } else {\n                    resolve(bundle);\n                }\n            });\n        });\n\n        return bundlePromise;\n    }\n\n    /**\n     * 获取资源包\n     * @param name 资源包名\n     */\n    getBundle(name: string): AssetManager.Bundle | undefined {\n        return assetManager.bundles.get(name);\n    }\n\n    /**\n     * 确保资源包已加载\n     */\n    private async ensureBundle(name: string): Promise<AssetManager.Bundle> {\n        let bundle = assetManager.bundles.get(name);\n        if (!bundle) {\n            bundle = await this.loadBundle(name);\n        }\n        return bundle;\n    }\n\n\n    /**\n     * 释放资源\n     * @param options 释放选项\n     */\n    release(options: ResOptions) {\n        const bundleName = options.bundleName || this.defaultBundleName;\n        const bundle = assetManager.getBundle(bundleName);\n\n        if (bundle) {\n            const asset = bundle.get(options.path);\n            if (asset) {\n                asset.decRef();\n            }\n        }\n    }\n\n\n}"]}