{"version":3,"sources":["file:///Users/michael/Desktop/gitfiles/coscos_oop_frame_wrok/assets/core/gui/base/UILayerNodeBase.ts"],"names":["UILayerNodeBase","instantiate","Node","Prefab","UIHelper","UIElementComponent","Fwk","constructor","name","onOpenFailure","ui_nodes","Map","setFullScreen","on","EventType","CHILD_ADDED","onChildAdded","CHILD_REMOVED","onChildRemoved","child","addView","uiInfo","has","config","prefab","get","valid","log","debug","Promise","reject","load","set","node","removeView","prefabPath","UIViewStateinfo","need_realse","destroy","comp","getComponent","finalizeRemoveUI","destroyNode","closeUi","removeFromLayer","timerId","setTimeout","onLoadingTimeoutGui","res","resMgr","paths","type","bundle","addComponent","warn","failure","clearTimeout","r","initializeUI","params","preload","parent","console","delete","release","info","onDestroy","off","forEach","clear"],"mappings":"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","sourcesContent":["/**\n * \n * P0 - 立即修复:\n\n改用组合替代继承 Node （引用ecs架构）\n完善错误处理和类型定义\n\nP1 - 近期优化:\n\n实现可配置的超时机制\n添加资源引用计数\n优化状态查询接口\n\nP2 - 长期演进:\n\n引入依赖注入容器\n实现 UI 生命周期的中间件机制\n添加性能监控埋点\n * \n */\nimport { instantiate, Node, Prefab } from \"cc\";\nimport { UIHelper } from \"../UIHelper\";\nimport { UIViewState } from \"./UIViewState\";\nimport { UIElementComponent } from \"../layer/UIElementComponent\";\nimport { Fwk } from \"../../Fwks\";\n\n\nexport abstract class UILayerNodeBase extends Node {\n    /** 全局窗口打开失败事件 */\n    onOpenFailure: Function = null!;\n\n    /** 显示界面节点集合 */\n    protected ui_nodes = new Map<string, UIViewState>();\n\n\n    constructor(name: string) {\n\n        super(name);\n\n        UIHelper.setFullScreen(this);\n\n\n        this.on(Node.EventType.CHILD_ADDED, this.onChildAdded, this);\n        this.on(Node.EventType.CHILD_REMOVED, this.onChildRemoved, this);\n    }\n\n\n    protected onChildAdded(child: Node) {\n\n\n    }\n\n    protected onChildRemoved(child: Node): void {\n\n    }\n\n    public async addView(uiInfo: UIViewState): Promise<Node> {\n\n        if (this.ui_nodes.has(uiInfo.config.prefab) && this.ui_nodes.get(uiInfo.config.prefab)!.valid) {\n            Fwk.log.debug(`UILayerNodeBase: 已存在相同的 UI 节点，无法重复添加: ${uiInfo.config.prefab}`);\n            return Promise.reject(`已存在相同的 UI 节点，无法重复添加: ${uiInfo.config.prefab}`);\n        }\n\n\n        await this.load(uiInfo);\n\n        this.ui_nodes.set(uiInfo.config.prefab, uiInfo);\n\n        return uiInfo.node;\n    }\n\n\n    public removeView(prefabPath: string): void {\n        const UIViewStateinfo = this.ui_nodes.get(prefabPath);\n        if (UIViewStateinfo == null) return;\n\n        let need_realse = UIViewStateinfo.config.destroy\n\n        if (!need_realse) {\n            // 可以实现界面缓存逻辑\n        }\n\n        const comp = UIViewStateinfo.node.getComponent(UIElementComponent);\n\n\n        if (comp) {\n            comp.finalizeRemoveUI();\n\n            if (need_realse) {\n\n                comp.destroyNode()\n\n                this.closeUi(UIViewStateinfo)\n\n            } else {\n\n                comp.removeFromLayer()\n\n            }\n        }\n\n    }\n\n    protected async load(uiInfo: UIViewState): Promise<Node> {\n        // 加载界面资源超时提示\n        if (uiInfo.node == null) {\n            let timerId = setTimeout(this.onLoadingTimeoutGui, 1000);\n\n            // 优先加载配置的指定资源包中资源，如果没配置则加载默认资源包资源\n            const res = await Fwk.resMgr.load({\n                paths: uiInfo.config.prefab,\n                type: Prefab,\n                bundle: uiInfo.config.bundle\n            }) as Prefab;\n            if (res) {\n                uiInfo.node = instantiate(res);\n\n                // // 是否启动真机安全区域显示\n                // if (state.config.safeArea) state.node.addComponent(SafeArea);\n\n                // 窗口事件委托\n                const comp = uiInfo.node.addComponent(UIElementComponent);\n\n                comp.uiInfo = uiInfo;\n            }\n            else {\n                Fwk.log.warn(`路径为【${uiInfo.config.prefab}】的预制加载失败`);\n                this.failure(uiInfo);\n            }\n\n            // 关闭界面资源超时提示\n            // oops.gui.waitClose();\n            clearTimeout(timerId);\n        }\n\n        const comp = uiInfo.node.getComponent(UIElementComponent)!;\n        const r: boolean = await comp.initializeUI();\n        if (r) {\n            uiInfo.valid = true;                         // 标记界面为使用状态\n            if (!uiInfo.params.preload) {\n                uiInfo.params.preload = false;\n                uiInfo.node.parent = this;\n            }\n        }\n        else {\n            console.warn(`路径为【${uiInfo.config.prefab}】的自定义预处理逻辑异常.检查预制上绑定的组件中 onAdded 方法,返回true才能正确完成窗口显示流程`);\n            this.failure(uiInfo);\n        }\n\n\n        return uiInfo.node;\n    }\n\n\n    /** 加载超时事件*/\n    private onLoadingTimeoutGui() {\n        // oops.gui.waitOpen();\n    }\n\n    /** 打开窗口失败逻辑 */\n    protected failure(uiInfo: UIViewState) {\n        this.closeUi(uiInfo);\n        this.onOpenFailure && this.onOpenFailure();\n    }\n\n    /** 窗口关闭事件 */\n    protected closeUi(uiInfo: UIViewState) {\n        this.ui_nodes.delete(uiInfo.config.prefab);\n        // 释放界面相关资源\n        Fwk.resMgr.release({\n            paths: uiInfo.config.prefab,\n            bundle: uiInfo.config.bundle,\n            type: Prefab\n        });\n\n        Fwk.log.info(`【界面管理】释放【${uiInfo.config.prefab}】界面资源`);\n    }\n\n    protected onDestroy(): void {\n\n        this.off(Node.EventType.CHILD_ADDED, this.onChildAdded, this);\n        this.off(Node.EventType.CHILD_REMOVED, this.onChildRemoved, this);\n        // 先销毁所有 UI 节点\n        this.ui_nodes.forEach((uiInfo) => {\n            if (uiInfo.node) {\n                const comp = uiInfo.node.getComponent(UIElementComponent);\n                if (comp) {\n                    comp.finalizeRemoveUI();\n                    comp.destroyNode();\n                }\n            }\n        });\n        // 清理所有 UI 节点\n        this.ui_nodes.clear();\n    }\n\n\n\n}\n"]}